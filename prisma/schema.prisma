// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "darwin-arm64"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  USER
}

enum AttendanceStatus {
  OFFICE       // В офисе
  REMOTE       // Из дома
  SICK         // Больничный
  VACATION     // Отпуск
  DAYOFF       // Отгул
  WEEKEND      // Выходной
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum RecurrenceType {
  DAILY
  WEEKLY
  MONTHLY
}

enum VacationStatus {
  PENDING      // Ожидает рассмотрения
  APPROVED     // Одобрено
  REJECTED     // Отклонено
  CANCELLED    // Отменено
}

enum ApprovalLevel {
  MANAGER      // Руководитель
  HR           // HR
  DIRECTOR     // Директор
}

enum CommentType {
  NORMAL       // Обычный
  IMPORTANT    // Важный
  CRITICAL     // Критичный
  INFO         // Информационный
}

enum ArticleStatus {
  DRAFT        // Черновик
  PENDING      // На проверке
  PUBLISHED    // Опубликовано
  REJECTED     // Отклонено
}

enum ArticleContentType {
  TEXT         // Текстовая статья (Markdown)
  DOCX         // Загруженный Word документ
  PDF          // Загруженный PDF документ
}

model User {
  id                String              @id @default(cuid())
  email             String              @unique
  password          String
  role              Role                @default(USER)
  name              String
  phone             String?
  position          String?
  skills            String?             // Профиль знаний
  avatar            String?             // Путь к файлу аватарки
  vacationDays      Int                 @default(28) // Доступные дни отпуска в году
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  attendances       Attendance[]
  changeRequests    AttendanceRequest[]
  recurringPatterns RecurringPattern[]
  vacationRequests  VacationRequest[]
  vacationApprovals VacationApproval[]
  sickLeaves        SickLeave[]
  workTimes         WorkTime[]
  overtimeWorks     OvertimeWork[]
  dayComments       DayComment[]
  swapRequestsInitiated ScheduleSwapRequest[] @relation("SwapRequester")
  swapRequestsReceived  ScheduleSwapRequest[] @relation("SwapTarget")
  swapRequestsReviewed  ScheduleSwapRequest[] @relation("SwapAdminReviewer")

  // База знаний
  articlesAuthored      KbArticle[]           @relation("ArticleAuthor")
  articleVersionsEdited KbArticleVersion[]    @relation("ArticleVersionEditor")
  articleComments       KbComment[]           @relation("ArticleCommentAuthor")
  favoriteArticles      KbFavorite[]          @relation("UserFavorites")
  uploadedMedia         KbMedia[]             @relation("MediaUploader")

  @@map("users")
}

model Attendance {
  id        String            @id @default(cuid())
  userId    String
  date      DateTime          // Дата присутствия
  status    AttendanceStatus
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  
  user      User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, date])
  @@index([date])
  @@map("attendances")
}

model AttendanceRequest {
  id          String         @id @default(cuid())
  userId      String
  date        DateTime       // Дата, на которую запрос
  newStatus   AttendanceStatus
  reason      String         // Причина запроса
  status      RequestStatus  @default(PENDING)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  
  user        User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([status])
  @@map("attendance_requests")
}

model RecurringPattern {
  id            String            @id @default(cuid())
  userId        String
  status        AttendanceStatus
  recurrenceType RecurrenceType
  dayOfWeek     Int?              // 1-7 (понедельник-воскресенье) для WEEKLY
  dayOfMonth    Int?              // 1-31 для MONTHLY
  isActive      Boolean           @default(true)
  startDate     DateTime?         // Необязательно: начало действия правила
  endDate       DateTime?         // Необязательно: конец действия правила
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  
  user          User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("recurring_patterns")
}

model VacationRequest {
  id            String              @id @default(cuid())
  userId        String
  startDate     DateTime            // Начало отпуска
  endDate       DateTime            // Конец отпуска
  days          Int                 // Количество дней
  reason        String?             // Причина (опционально)
  status        VacationStatus      @default(PENDING)
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  
  user          User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  approvals     VacationApproval[]
  
  @@index([userId])
  @@index([status])
  @@map("vacation_requests")
}

model VacationApproval {
  id                String            @id @default(cuid())
  vacationRequestId String
  approverId        String
  level             ApprovalLevel
  status            VacationStatus    // APPROVED или REJECTED
  comment           String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  
  vacationRequest   VacationRequest   @relation(fields: [vacationRequestId], references: [id], onDelete: Cascade)
  approver          User              @relation(fields: [approverId], references: [id], onDelete: Cascade)
  
  @@unique([vacationRequestId, level])
  @@map("vacation_approvals")
}

model SickLeave {
  id            String      @id @default(cuid())
  userId        String
  startDate     DateTime    // Начало больничного
  endDate       DateTime    // Конец больничного
  days          Int         // Количество дней
  diagnosis     String?     // Диагноз (опционально)
  documentPath  String?     // Путь к скану больничного листа
  notes         String?     // Дополнительные заметки
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([startDate])
  @@map("sick_leaves")
}

model WorkTime {
  id          String      @id @default(cuid())
  userId      String
  date        DateTime    // Дата
  checkIn     DateTime?   // Время прихода
  checkOut    DateTime?   // Время ухода
  totalHours  Float       @default(0) // Всего часов (общее время)
  breakTime   Float       @default(0) // Время перерывов в часах
  netHours    Float       @default(0) // Чистое рабочее время (totalHours - breakTime)
  overtime    Float       @default(0) // Сверхурочные часы (на основе netHours)
  notes       String?     // Примечания
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  breaks      WorkBreak[]

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
  @@map("work_times")
}

model WorkBreak {
  id          String      @id @default(cuid())
  workTimeId  String
  startTime   DateTime    // Начало перерыва
  endTime     DateTime?   // Конец перерыва (null = ещё на перерыве)
  duration    Float       @default(0) // Длительность в минутах
  type        String      @default("BREAK") // BREAK | LUNCH | OTHER
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  workTime    WorkTime    @relation(fields: [workTimeId], references: [id], onDelete: Cascade)

  @@index([workTimeId])
  @@index([startTime])
  @@map("work_breaks")
}

model OvertimeWork {
  id            String      @id @default(cuid())
  userId        String
  date          DateTime    // Дата (день когда работали)
  startTime     DateTime    // Точное время начала переработки
  endTime       DateTime?   // Точное время окончания
  duration      Float       @default(0) // Длительность в часах
  description   String      // Описание выполненных работ
  isConfirmed   Boolean     @default(false) // Подтверждено руководителем
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([date])
  @@index([isConfirmed])
  @@map("overtime_works")
}

model DayComment {
  id            String      @id @default(cuid())
  date          DateTime    // Дата дня, к которому относится комментарий
  userId        String      // Автор комментария
  text          String      @db.Text // Текст комментария
  type          CommentType @default(NORMAL) // Тип комментария (обычный, важный, критичный)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([date])
  @@index([userId])
  @@index([type])
  @@map("day_comments")
}

// Запросы на обмен графиками
model ScheduleSwapRequest {
  id                String        @id @default(cuid())
  requesterId       String        // Кто инициирует обмен
  targetUserId      String        // С кем хочет поменяться
  date              DateTime      // Дата обмена
  requesterOldStatus AttendanceStatus // Текущий статус инициатора
  requesterNewStatus AttendanceStatus // Желаемый статус инициатора
  targetOldStatus   AttendanceStatus // Текущий статус партнера
  targetNewStatus   AttendanceStatus // Желаемый статус партнера
  reason            String?       // Причина обмена
  status            RequestStatus @default(PENDING)
  targetApproved    Boolean       @default(false) // Согласие второго сотрудника
  adminReviewedBy   String?       // Кто из админов рассмотрел
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  
  requester         User          @relation("SwapRequester", fields: [requesterId], references: [id], onDelete: Cascade)
  targetUser        User          @relation("SwapTarget", fields: [targetUserId], references: [id], onDelete: Cascade)
  adminReviewer     User?         @relation("SwapAdminReviewer", fields: [adminReviewedBy], references: [id], onDelete: SetNull)
  
  @@index([requesterId])
  @@index([targetUserId])
  @@index([date])
  @@index([status])
  @@map("schedule_swap_requests")
}

// ═════════════════════════════════════════════════════════
// БАЗА ЗНАНИЙ (Knowledge Base)
// ═════════════════════════════════════════════════════════

// Категории статей
model KbCategory {
  id          String       @id @default(cuid())
  name        String
  icon        String?      // Emoji или иконка
  description String?      @db.Text
  parentId    String?      // Для вложенных категорий
  createdAt   DateTime     @default(now())
  
  parent      KbCategory?  @relation("CategoryTree", fields: [parentId], references: [id], onDelete: SetNull)
  children    KbCategory[] @relation("CategoryTree")
  articles    KbArticle[]
  
  @@index([parentId])
  @@map("kb_categories")
}

// Статьи
model KbArticle {
  id                String              @id @default(cuid())
  title             String
  slug              String              @unique // Для URL
  content           String              @db.Text // Markdown контент или HTML из DOCX
  contentType       ArticleContentType  @default(TEXT) // Тип контента
  filePath          String?             // Путь к файлу (для DOCX/PDF)
  fileSize          Int?                // Размер файла в байтах
  originalFileName  String?             // Оригинальное имя файла
  categoryId        String?
  authorId          String
  status            ArticleStatus       @default(DRAFT)
  viewsCount        Int                 @default(0)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  category    KbCategory?       @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  author      User              @relation("ArticleAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  
  tags        KbArticleTag[]
  versions    KbArticleVersion[]
  comments    KbComment[]
  favorites   KbFavorite[]
  media       KbMedia[]
  linksFrom   KbArticleLink[]   @relation("ArticleLinksFrom")
  linksTo     KbArticleLink[]   @relation("ArticleLinksTo")
  
  @@index([categoryId])
  @@index([authorId])
  @@index([status])
  @@index([slug])
  @@map("kb_articles")
}

// Теги
model KbTag {
  id          String          @id @default(cuid())
  name        String          @unique
  createdAt   DateTime        @default(now())
  
  articles    KbArticleTag[]
  
  @@map("kb_tags")
}

// Связь статей с тегами
model KbArticleTag {
  articleId   String
  tagId       String
  
  article     KbArticle       @relation(fields: [articleId], references: [id], onDelete: Cascade)
  tag         KbTag           @relation(fields: [tagId], references: [id], onDelete: Cascade)
  
  @@id([articleId, tagId])
  @@index([articleId])
  @@index([tagId])
  @@map("kb_article_tags")
}

// Ссылки между статьями
model KbArticleLink {
  sourceArticleId String
  targetArticleId String
  createdAt       DateTime      @default(now())
  
  sourceArticle   KbArticle     @relation("ArticleLinksFrom", fields: [sourceArticleId], references: [id], onDelete: Cascade)
  targetArticle   KbArticle     @relation("ArticleLinksTo", fields: [targetArticleId], references: [id], onDelete: Cascade)
  
  @@id([sourceArticleId, targetArticleId])
  @@index([sourceArticleId])
  @@index([targetArticleId])
  @@map("kb_article_links")
}

// История версий
model KbArticleVersion {
  id                String              @id @default(cuid())
  articleId         String
  title             String
  content           String              @db.Text
  contentType       ArticleContentType  @default(TEXT) // Тип контента версии
  filePath          String?             // Путь к файлу версии (для DOCX/PDF)
  fileSize          Int?                // Размер файла версии
  originalFileName  String?             // Имя файла версии
  editedBy          String
  createdAt         DateTime            @default(now())

  article           KbArticle           @relation(fields: [articleId], references: [id], onDelete: Cascade)
  editor            User                @relation("ArticleVersionEditor", fields: [editedBy], references: [id], onDelete: Cascade)

  @@index([articleId])
  @@index([editedBy])
  @@map("kb_article_versions")
}

// Комментарии к статьям
model KbComment {
  id          String        @id @default(cuid())
  articleId   String
  userId      String
  content     String        @db.Text
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  article     KbArticle     @relation(fields: [articleId], references: [id], onDelete: Cascade)
  user        User          @relation("ArticleCommentAuthor", fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([articleId])
  @@index([userId])
  @@map("kb_comments")
}

// Избранное пользователей
model KbFavorite {
  userId      String
  articleId   String
  createdAt   DateTime      @default(now())
  
  user        User          @relation("UserFavorites", fields: [userId], references: [id], onDelete: Cascade)
  article     KbArticle     @relation(fields: [articleId], references: [id], onDelete: Cascade)
  
  @@id([userId, articleId])
  @@index([userId])
  @@index([articleId])
  @@map("kb_favorites")
}

// Медиафайлы (изображения, видео)
model KbMedia {
  id          String        @id @default(cuid())
  articleId   String?       // Опционально: можно загружать файлы без привязки к статье
  filename    String
  url         String        // URL для доступа к файлу (/uploads/kb/...)
  filePath    String        // Полный путь к файлу на сервере
  fileType    String        // image, video
  fileSize    Int           // В байтах
  uploadedBy  String
  createdAt   DateTime      @default(now())

  article     KbArticle?    @relation(fields: [articleId], references: [id], onDelete: Cascade)
  uploader    User          @relation("MediaUploader", fields: [uploadedBy], references: [id], onDelete: Cascade)

  @@index([articleId])
  @@index([uploadedBy])
  @@map("kb_media")
}
